### Creating a Service Account

#### To crate a service account, run the following command:

```
kubectl create serviceaccount dashboard-sa
```

#### To view all service accounts, use:

```
kubectl get serviceaccount
```

When the service account is created, a token is automatically generated. This token must be used by the external application to authenticate with the Kubernetes API

### Service Account Token

- The token is stored as a secret object. For example, if the secret is named <code>dashboard-sa-tokeb-kbbdm</code>:

  - The service account object is created first
  - A token for the service account is generated
  - A secret object is created and linked to the service account

- To view the secret and token:
  ```
  kubectl describe secret <secret-name>
  ```
  This token can be used as a Bearer Token in the <code>Authorization</code> header while making REST calls to the Kubernetes API. For instance:
  ```
  curl -H "Authorization: Bearer <token>" https://<kubernetes-api-endpoint>
  ```

### Using Service Acounts for Applications

1. External Applications:
   - Export the token from the secret and configure your application with it
   - The application will use this token to authenticate with the Kubernetes API
2. Applications Deployed on the Kubernetes Cluster: - Kubernetes automatically mounts the service account token secret as a volume inside the pod hosting the application - The token is placed at the path:
   `   /var/run/secrets/kubernetes.io/serviceaccount`
   If you run <code>ls</code> command line inside the pod to list the contents of this directory, you will see three files. The file named <code>token</code> contains the actual token

### Default Service Account

- Each namespace in Kubernetes has a default service account
- When a pod is created, the default service account and its token are automatically mounted to the pod as a volume
- If you don't want this to happen, you can disable it by setting <code>automountServiceAccountToken</code> to <code>false</code> in the pod spec:
  ```
  automountServiceAccountToken: false
  ```

### Using a Custom Service Account

- If you want to use a custom service account (e.g., <code>dashboard-sa</code>), update the pod definition to include the <code>serviceAccountName</code> field:
  ```
  spec:
      serviceAccountName: dashboard-sa
  ```
- Important:
  - You cannot edit the service accoubt of an existing pod. You must delete and recreate the pod
  - For deployments, changes to the service account in the pod spec automatically trigger a new rollout

### Changes in Kubernetes v1.22 and v1.24

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: nginx
  namespace: default
spec:
  containers:
    - name: nginx
      image: nginx
      volumeMounts:
        - mountPath: /var/run/secrets/kubernetes.io/serviceaccount
          name: kube-api-access-6mtg8
          readOnly: true
  volumes:
    - name: kube-api-access-6mtg8
      projected:
        defaultMode: 420
        sources:
          - serviceAccountToken:
              expirationSeconds: 3607
              path: token
          - configMap:
              name: kube-root-ca.crt
              items:
                - key: ca.crt
                  path: ca.crt
          - downwardAPI:
              items:
                - fieldRef:
                    apiVersion: v1
```

1. Version 1.22: Introduction of TokenRequestAPI:
   - Tokens are now audience-bound, time-bound, and object-bound for improved security
   - Instead of relying on service account secret tokens, tokens are dynamically generated by the TokenRequestAPI when a pod is created. These tokens are mounted as projected volumes.
2. Version 1.24: No More Automatic Secret Creation:
   - Service accounts no longer automatically create a secret or a token
   - To generate a token for a service account, use:
   ```
   kubectl create token <service-account-name>
   ```

### Legacy Secrets

If you need to create a non-expiring token (not recommended), you can manually create a secret and associate it with a service account:

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: custom-secret
  annotations:
    kubernetes.io/service-account.name: dashboard-sa
type: kubernetes.io/service-account-token
```
